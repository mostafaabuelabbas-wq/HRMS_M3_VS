@model IEnumerable<HRMS_M3_VS.Areas.Employee.Models.MissionDto>

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Missions & Travel</h2>
            <p class="text-muted mb-0 small">Manage assigned tasks and business trips.</p>
        </div>

        <!-- Only HR can Create -->
        @if (User.IsInRole("HRAdmin"))
        {
            <a asp-action="Create" class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold">
                <i class="fas fa-plus me-2"></i>Assign Mission
            </a>
        }
    </div>

    <!-- Main Card -->
    <div class="card shadow border-0 rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-uppercase text-secondary small fw-bold" style="width: 25%;">Details</th>
                        <th class="py-3 text-uppercase text-secondary small fw-bold" style="width: 30%;">Destination & Description</th> <!-- Updated Header -->
                        <th class="py-3 text-uppercase text-secondary small fw-bold">Timeline</th>
                        <th class="py-3 text-uppercase text-secondary small fw-bold text-center">Status</th>

                        <!-- Manager Actions Column -->
                        @if (User.IsInRole("Manager"))
                        {
                            <th class="pe-4 py-3 text-uppercase text-secondary small fw-bold text-end">Approvals</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <!-- Empty State -->
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="opacity-25 mb-3">
                                    <i class="fas fa-plane-slash fa-4x text-secondary"></i>
                                </div>
                                <h6 class="text-muted fw-bold">No missions found</h6>
                                <p class="text-muted small mb-0">Assignments will appear here once created.</p>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model)
                        {
                            // Calculate Duration
                            var days = (item.End_Date - item.Start_Date).Days + 1;

                            <tr>
                                <!-- Column 1: Context (Employee or Self) -->
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex justify-content-center align-items-center me-3 fw-bold"
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-briefcase"></i>
                                        </div>
                                        <div>
                                            @if (!string.IsNullOrEmpty(item.EmployeeName))
                                            {
                                                <div class="fw-bold text-dark">@item.EmployeeName</div>
                                                <div class="small text-muted" style="font-size: 0.75rem;">
                                                    Supervisor: @(item.ManagerName ?? "Direct Manager")
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="fw-bold text-dark">My Mission</div>
                                                <div class="small text-muted" style="font-size: 0.75rem;">Assigned to me</div>
                                            }
                                        </div>
                                    </div>
                                </td>

                                <!-- Column 2: Destination & Description (UPDATED) -->
                                <td>
                                    <!-- Destination -->
                                    <div class="fw-semibold text-dark mb-1">
                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>@item.Destination
                                    </div>

                                    <!-- Description (New Part) -->
                                    @if (!string.IsNullOrEmpty(item.Description))
                                    {
                                        <div class="text-muted small text-wrap" style="max-width: 300px; line-height: 1.4;">
                                            <i class="fas fa-info-circle me-1 text-secondary opacity-50"></i>
                                            @item.Description
                                        </div>
                                    }
                                </td>

                                <!-- Column 3: Dates -->
                                <td>
                                    <div class="small text-dark fw-bold">@item.Start_Date.ToString("MMM dd") - @item.End_Date.ToString("MMM dd, yyyy")</div>
                                    <div class="small text-muted">@days Days duration</div>
                                </td>

                                <!-- Column 4: Status -->
                                <td class="text-center">
                                    @if (item.Status == "Pending")
                                    {
                                        <span class="badge rounded-pill bg-warning text-dark border border-warning px-3">Pending</span>
                                    }
                                    else if (item.Status == "Approved" || item.Status == "Completed")
                                    {
                                        <span class="badge rounded-pill bg-success bg-opacity-10 text-success border border-success px-3">@item.Status</span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger border border-danger px-3">Rejected</span>
                                    }
                                </td>

                                <!-- Column 5: Manager Actions -->
                                @if (User.IsInRole("Manager"))
                                {
                                    <td class="text-end pe-4">
                                        @if (item.Status == "Pending")
                                        {
                                            <form asp-action="UpdateStatus" method="post" class="d-inline">
                                                <input type="hidden" name="id" value="@item.Mission_Id" />

                                                <div class="d-flex justify-content-end gap-2">
                                                    <!-- Approve -->
                                                    <button type="submit" name="status" value="Approved"
                                                            class="btn btn-sm btn-success px-3 rounded-3 fw-bold shadow-sm"
                                                            title="Approve Mission">
                                                        <i class="fas fa-check me-1"></i> Approve
                                                    </button>

                                                    <!-- Reject -->
                                                    <button type="submit" name="status" value="Rejected"
                                                            class="btn btn-sm btn-outline-danger px-3 rounded-3 fw-bold shadow-sm"
                                                            title="Reject Mission">
                                                        <i class="fas fa-times me-1"></i> Reject
                                                    </button>
                                                </div>
                                            </form>
                                        }
                                        else
                                        {
                                            @if (item.Status == "Approved" || item.Status == "Completed")
                                            {
                                                <span class="text-success small fw-bold"><i class="fas fa-check-circle me-1"></i> Approved</span>
                                            }
                                            else
                                            {
                                                <span class="text-danger small fw-bold"><i class="fas fa-times-circle me-1"></i> Rejected</span>
                                            }
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>