@model IEnumerable<HRMS_M3_VS.Areas.Employee.Models.TeamAttendanceLogDto>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Team Attendance";

    // Quick Stats Calculations
    var totalRecords = Model.Count();
    var late = Model.Count(x => x.entry_time.HasValue && x.entry_time.Value.TimeOfDay > new TimeSpan(9, 15, 0));
    var onLeave = Model.Count(x => x.login_method == "Leave" || x.login_method == "LeaveSync");

    // Admin Toggle Logic
    bool isViewAll = ViewBag.IsViewAll ?? false;
    bool canViewAll = ViewBag.CanViewAll ?? false;
}

<div class="container-fluid p-0">

    <!-- 1. HEADER & CONTROLS -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-primary fw-bold mb-1">
                @if (isViewAll)
                {
                    <i class="fa fa-globe me-2"></i>
                    <span>All Employees</span>
 }
                else
                {
                    <i class="fa fa-users-cog me-2"></i>
                    <span>My Team</span>
 }
            </h3>
            <p class="text-muted small mb-0">
                Data: <strong>@ViewBag.Start.ToString("MMM dd")</strong> to <strong>@ViewBag.End.ToString("MMM dd")</strong>
            </p>
        </div>

        <div class="d-flex gap-2 mt-3 mt-md-0">
            <!-- Quick Filter Buttons -->
            <div class="btn-group shadow-sm" role="group">
                <a asp-action="Index" asp-route-filter="today" asp-route-viewAll="@isViewAll" class="btn btn-outline-primary @(ViewBag.Filter == "today" ? "active" : "")">Today</a>
                <a asp-action="Index" asp-route-filter="week" asp-route-viewAll="@isViewAll" class="btn btn-outline-primary @(ViewBag.Filter == "week" ? "active" : "")">Week</a>
                <a asp-action="Index" asp-route-filter="month" asp-route-viewAll="@isViewAll" class="btn btn-outline-primary @(ViewBag.Filter == "month" ? "active" : "")">Month</a>
            </div>

            <!-- ADMIN ONLY: Toggle View All -->
            @if (canViewAll)
            {
                if (isViewAll)
                {
                    <a asp-action="Index" asp-route-viewAll="false" class="btn btn-secondary shadow-sm">
                        <i class="fa fa-compress-arrows-alt me-1"></i> My Team Only
                    </a>
                }
                else
                {
                    <a asp-action="Index" asp-route-viewAll="true" class="btn btn-dark shadow-sm">
                        <i class="fa fa-expand-arrows-alt me-1"></i> View All Employees
                    </a>
                }
            }
        </div>
    </div>

    <!-- 2. SUMMARY CARDS -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 border-primary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">Total Logs</h6>
                    <h3 class="mb-0 text-dark">@totalRecords</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 border-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">Late Arrivals</h6>
                    <h3 class="mb-0 text-warning">@late</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 border-info">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">On Leave</h6>
                    <h3 class="mb-0 text-info">@onLeave</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. DATA TABLE -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Attendance Logs</h6>

            <!-- Instant Search Box -->
            <input type="text" id="teamSearch" class="form-control bg-light border-0"
                   placeholder="Search employee name..." onkeyup="filterTable()" style="max-width: 250px;">
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="attendanceTable">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Employee</th>
                        <th>Date</th>
                        <th>In</th>
                        <th>Out</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th class="text-end pe-4">Action</th> <!-- RESTORED COLUMN -->
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="text-muted opacity-50">
                                    <i class="fa fa-search fa-3x mb-3"></i>
                                    <h5>No records found</h5>
                                    <p class="mb-3">No attendance data for this period.</p>

                                    <div class="d-flex justify-content-center gap-2">
                                        <a asp-action="Index" asp-route-filter="month" asp-route-viewAll="@isViewAll" class="btn btn-sm btn-outline-primary">
                                            Check this Month
                                        </a>
                                        @if (canViewAll && !isViewAll)
                                        {
                                            <a asp-action="Index" asp-route-viewAll="true" class="btn btn-sm btn-dark">
                                                Search All Employees
                                            </a>
                                        }
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var log in Model)
                        {
                            <tr>
                                <!-- Employee Info -->
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light text-primary rounded-circle d-flex justify-content-center align-items-center me-3 fw-bold" style="width: 40px; height: 40px;">
                                            @(log.full_name?.Substring(0, 1) ?? "?")
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">@log.full_name</div>
                                            <div class="small text-muted">ID: @log.employee_id</div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Date -->
                                <td class="fw-bold text-secondary">
                                    @(log.entry_time.HasValue? log.entry_time.Value.ToString("MMM dd") : "-")
                                </td>

                                <!-- In Time -->
                                <td class="text-success font-monospace">
                                    @(log.entry_time.HasValue? log.entry_time.Value.ToString("hh:mm tt") : "-")
                                </td>

                                <!-- Out Time -->
                                <td class="text-danger font-monospace">
                                    @(log.exit_time.HasValue? log.exit_time.Value.ToString("hh:mm tt") : "-")
                                </td>

                                <!-- Duration -->
                                <td>
                                    @if (log.duration.HasValue && log.duration > 0)
                                    {
                                        <span>@Math.Round(log.duration.Value / 60.0, 1) hrs</span>
                                    }
                                    else
                                    {

                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- Status Badge -->
                                <td>
                                    @if (log.login_method != null && (log.login_method.Contains("Leave")))
                                    {
                                        <span class="badge bg-info-subtle text-info border border-info-subtle rounded-pill">Leave</span>
                                    }
                                    else if (log.exception_id != null)
                                    {

                                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill">Exception</span>
                                    }
                                    else if (log.exit_time == null)
                                    {

                                        <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">Working</span>
                                    }
                                    else
                                    {

                                        <span class="badge bg-light text-secondary border rounded-pill">Done</span>
                                    }
                                </td>

                                <!-- RESTORED ACTION BUTTON -->
                                <td class="text-end pe-4">
                                    <a asp-action="History" asp-route-id="@log.employee_id"
                                       class="btn btn-sm btn-outline-secondary rounded-pill px-3"
                                       title="View Full History">
                                        <i class="fa fa-history me-1"></i> History
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Manual Date Picker (Collapsed) -->
    <div class="mt-3 text-end">
        <button class="btn btn-sm btn-link text-decoration-none text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#manualFilter">
            Need specific dates?
        </button>
        <div class="collapse mt-2" id="manualFilter">
            <form method="get" class="card card-body shadow-sm d-inline-flex flex-row gap-2 align-items-center justify-content-end border-0">
                <input type="hidden" name="filter" value="custom" />
                <input type="hidden" name="viewAll" value="@isViewAll.ToString().ToLower()" />

                <label class="small fw-bold">From:</label>
                <input type="date" name="start" class="form-control form-control-sm" value="@ViewBag.Start.ToString("yyyy-MM-dd")" style="width: auto;" />

                <label class="small fw-bold">To:</label>
                <input type="date" name="end" class="form-control form-control-sm" value="@ViewBag.End.ToString("yyyy-MM-dd")" style="width: auto;" />

                <button type="submit" class="btn btn-sm btn-secondary">Apply</button>
            </form>
        </div>
    </div>

</div>

<!-- Search Script -->
<script>
    function filterTable() {
        var input = document.getElementById("teamSearch");
        var filter = input.value.toUpperCase();
        var table = document.getElementById("attendanceTable");
        var tr = table.getElementsByTagName("tr");

        for (var i = 1; i < tr.length; i++) {
            var td = tr[i].getElementsByTagName("td")[0];
            if (td) {
                var txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>