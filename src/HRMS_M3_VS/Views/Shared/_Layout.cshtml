@using System.Security.Claims
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - HRMS Enterprise</title>

    <!-- 1. EXTERNAL LIBRARIES -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

    <!-- 2. YOUR APP STYLES -->
    <link href="~/css/ui/app-ui.css" rel="stylesheet" asp-append-version="true" />
    <style>
        body {
            background-color: #0F172A; /* Slate 900 - Dark Background */
            color: #E2E8F0; /* Slate 200 - Light Text */
            font-family: 'Inter', sans-serif;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1E293B; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748B; 
        }
    </style>
</head>

<body>
    <!-- 1. SIDEBAR (Fixed Position) -->
    <nav id="app-sidebar" class="shadow-lg border-end border-secondary border-opacity-25">
        <!-- Brand -->
        <div class="sidebar-header border-bottom border-secondary border-opacity-25">
            <div class="brand-icon bg-primary bg-gradient text-white shadow">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="brand-text text-white">HR<span>MS</span></div>
        </div>

        <!-- Navigation Links (Scrollable) -->
        <div class="sidebar-content">
            <div class="nav-group">
                <div class="nav-label">General</div>
                <a class="nav-link" asp-area="" asp-controller="Dashboard" asp-action="Index">
                    <i class="fas fa-home"></i> <span>Dashboard</span>
                </a>
                <a class="nav-link" asp-area="Employee" asp-controller="Home" asp-action="MyProfile">
                    <i class="fas fa-id-card"></i> <span>My Profile</span>
                </a>
            </div>

            <div class="nav-group">
                <div class="nav-label">Workplace</div>
                <a class="nav-link" asp-area="Attendance" asp-controller="Track" asp-action="Index">
                    <i class="fas fa-clock"></i> <span>My Attendance</span>
                </a>
                <!-- Added My Leave from Master -->
                <a class="nav-link" asp-area="Leave" asp-controller="Leave" asp-action="MyLeave">
                    <i class="fas fa-calendar-check"></i> <span>My Leave</span>
                </a>
                <a class="nav-link" asp-area="Employee" asp-controller="Mission" asp-action="Index">
                    <i class="fas fa-briefcase"></i> <span>Missions</span>
                </a>
            </div>

            @if (User.IsInRole("Manager") || User.IsInRole("HRAdmin") || User.IsInRole("SystemAdmin"))
            {
                <div class="nav-group">
                    <div class="nav-label">Management</div>

                    @* TEAM PROFILES: Manager & System Admin *@
                    @if (User.IsInRole("Manager") || User.IsInRole("SystemAdmin")) 
                    {
                        <a class="nav-link" asp-area="Employee" asp-controller="Manager" asp-action="Index">
                            <i class="fas fa-users"></i> <span>Team Profiles</span>
                        </a>
                    }
                    
                    @* TEAM ATTENDANCE: Manager, HRAdmin, SystemAdmin (TeamAttendanceController logic) *@
                    @if (User.IsInRole("Manager") || User.IsInRole("SystemAdmin") || User.IsInRole("HRAdmin"))
                    {
                        <a class="nav-link" asp-area="Attendance" asp-controller="TeamAttendance" asp-action="Index">
                            <i class="fas fa-user-check"></i> <span>Team Attendance</span>
                        </a>
                    }

                    @* LEAVE REQUESTS: Manager or HRAdmin Only (LeaveController has [Authorize(Roles="Manager,HRAdmin")]) *@
                    @if (User.IsInRole("Manager") || User.IsInRole("HRAdmin"))
                    {
                        <a class="nav-link" asp-area="Leave" asp-controller="Leave" asp-action="Index">
                            <i class="fas fa-clipboard-check"></i> <span>Leave Requests</span>
                        </a>
                    }

                    @* SHIFTS: All Management Roles *@
                    @if (User.IsInRole("Manager") || User.IsInRole("HRAdmin") || User.IsInRole("SystemAdmin"))
                    {
                        <a class="nav-link" asp-area="Attendance" asp-controller="Shift" asp-action="Index">
                            <i class="fas fa-calendar-alt"></i> <span>Shifts</span>
                        </a>
                    }

                    @* OPERATIONS: Broad access for TimeRules *@
                    @if (User.IsInRole("Manager") || User.IsInRole("HRAdmin") || User.IsInRole("SystemAdmin"))
                    {
                        <a class="nav-link" asp-area="Attendance" asp-controller="AttendanceManager" asp-action="Index">
                            <i class="fas fa-tasks"></i> <span>Operations</span>
                        </a>
                    }
                </div>
            }

            @if (User.IsInRole("HRAdmin") || User.IsInRole("SystemAdmin"))
            {
                <div class="nav-group">
                    <div class="nav-label">HR Admin</div>
                    
                    @* DIRECTORY: System Admin Only (HR Admin Restricted) *@
                    @if (User.IsInRole("SystemAdmin"))
                    {
                        <a class="nav-link" asp-area="Employee" asp-controller="Home" asp-action="Index">
                            <i class="fas fa-address-book"></i> <span>Directory</span>
                        </a>
                    }

                    @* PROFILE COMPLETENESS: HR Admin Only *@
                    @if (User.IsInRole("HRAdmin"))
                    {
                        <a class="nav-link" asp-area="Employee" asp-controller="HRAdmin" asp-action="ProfileCompleteness">
                            <i class="fas fa-percentage"></i> <span>Completeness</span>
                        </a>
                    }

                    @* CONTRACTS: HR Admin Only *@
                    @if (User.IsInRole("HRAdmin"))
                    {
                        <a class="nav-link" asp-area="Employee" asp-controller="Contract" asp-action="Index">
                            <i class="fas fa-file-contract"></i> <span>Contracts</span>
                        </a>
                    }

                    @* LEAVE CONFIG: HR Admin or System Admin *@
                    @if (User.IsInRole("HRAdmin") || User.IsInRole("SystemAdmin"))
                    {
                        <a class="nav-link" asp-area="Leave" asp-controller="Leave" asp-action="ManageTypes">
                            <i class="fas fa-sliders-h"></i> <span>Leave Config</span>
                        </a>
                    }

                    @* LEAVE ENTITLEMENTS: HR Admin Only *@
                    @if (User.IsInRole("HRAdmin"))
                    {
                        <a class="nav-link" asp-area="Leave" asp-controller="Leave" asp-action="AssignEntitlement">
                            <i class="fas fa-user-edit"></i> <span>Entitlements</span>
                        </a>
                    }

                    @* VIEW FLAGS: HR Admin or System Admin *@
                    @if (User.IsInRole("HRAdmin") || User.IsInRole("SystemAdmin"))
                    {
                        <a class="nav-link" asp-area="Leave" asp-controller="Leave" asp-action="ViewFlags">
                            <i class="fas fa-exclamation-triangle"></i> <span>View Flags</span>
                        </a>
                    }

                    @* MANAGE REQUESTS: HR Admin or System Admin *@
                    @if (User.IsInRole("HRAdmin") || User.IsInRole("SystemAdmin"))
                    {
                        <a class="nav-link" asp-area="Leave" asp-controller="Leave" asp-action="ManageRequests">
                            <i class="fas fa-tasks"></i> <span>Manage Requests</span>
                        </a>
                    }
                </div>
            }

            @if (User.IsInRole("SystemAdmin"))
            {
                <div class="nav-group">
                    <div class="nav-label">System</div>
                    <a class="nav-link" asp-area="Employee" asp-controller="Role" asp-action="Index">
                        <i class="fas fa-shield-alt"></i> <span>Roles</span>
                    </a>
                    <a class="nav-link" asp-controller="AdminSettings" asp-action="Index">
                        <i class="fas fa-cogs"></i> <span>Settings</span>
                    </a>
                </div>
            }
        </div>

        <!-- User Footer -->
        <div class="sidebar-footer p-3 mt-auto border-top border-secondary border-opacity-10" style="background-color: rgba(0,0,0,0.2);">
            @if (User.Identity!.IsAuthenticated)
            {
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="user-avatar shadow-sm rounded-circle d-flex align-items-center justify-content-center fw-bold text-white" 
                         style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);">
                        @User.Identity.Name?.Substring(0, 1).ToUpper()
                    </div>
                    <div class="user-details overflow-hidden">
                        <div class="text-white fw-bold text-truncate">@User.Identity.Name</div>
                        <div class="text-muted small text-truncate" style="font-size: 0.75rem;">
                            @if (User.IsInRole("SystemAdmin")) { <text>System Admin</text> }
                            else if (User.IsInRole("HRAdmin")) { <text>HR Admin</text> }
                            else if (User.IsInRole("Manager")) { <text>Manager</text> }
                            else { <text>Employee</text> }
                        </div>
                    </div>
                </div>
            }
            
            <a asp-area="" asp-controller="Account" asp-action="Logout" class="btn btn-outline-danger w-100 fw-bold border-opacity-25 text-uppercase" style="letter-spacing: 0.5px; font-size: 0.8rem;">
                <i class="fas fa-sign-out-alt me-2"></i> Log Out
            </a>
        </div>
    </nav>

    <!-- 2. MAIN CONTENT (Pushed Right) -->
    <main id="app-main">
        <div class="container-fluid">
            @RenderBody()
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Highlight active sidebar navigation link and preserve scroll position
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarContent = document.querySelector('.sidebar-content');
            const currentPath = window.location.pathname.toLowerCase();
            const navLinks = document.querySelectorAll('#app-sidebar .nav-link');
            
            // Restore sidebar scroll position from localStorage
            const savedScrollPos = localStorage.getItem('sidebarScrollPosition');
            if (savedScrollPos && sidebarContent) {
                sidebarContent.scrollTop = parseInt(savedScrollPos, 10);
            }
            
            let bestMatch = null;
            let bestMatchLength = 0;
            
            navLinks.forEach(function(link) {
                const href = link.getAttribute('href');
                if (href) {
                    const linkPath = href.toLowerCase();
                    // Check if current path starts with or matches the link path
                    if (currentPath === linkPath || 
                        (currentPath.startsWith(linkPath) && linkPath.length > bestMatchLength && linkPath !== '/')) {
                        bestMatch = link;
                        bestMatchLength = linkPath.length;
                    }
                }
            });
            
            // Apply active class to best matching link and scroll it into view
            if (bestMatch) {
                bestMatch.classList.add('active');
                
                // If no saved scroll position, scroll the active link into view
                if (!savedScrollPos && sidebarContent) {
                    bestMatch.scrollIntoView({ block: 'center', behavior: 'instant' });
                }
            }
            
            // Save scroll position before navigating away
            navLinks.forEach(function(link) {
                link.addEventListener('click', function() {
                    if (sidebarContent) {
                        localStorage.setItem('sidebarScrollPosition', sidebarContent.scrollTop);
                    }
                });
            });
            
            // Also save on any page unload (in case of browser back/forward)
            window.addEventListener('beforeunload', function() {
                if (sidebarContent) {
                    localStorage.setItem('sidebarScrollPosition', sidebarContent.scrollTop);
                }
            });
        });
    </script>
    
    @RenderSection("Scripts", required: false)
</body>
</html>