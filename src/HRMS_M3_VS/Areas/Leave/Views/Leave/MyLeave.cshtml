@model HRMS_M3_VS.Areas.Leave.Models.EmployeeLeaveViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "My Leave";

    // ONLY Vacation is banked
    var vacation = Model.Balances.FirstOrDefault(b => b.leave_type == "Vacation");

    var policyLeaves = Model.Balances.Where(b => b.leave_type != "Vacation").ToList();

    decimal entitlement = vacation?.entitlement ?? 0;
    decimal used = vacation?.days_used ?? 0;
    decimal remaining = vacation?.remaining_balance ?? 0;

    decimal percent = entitlement > 0 ? (remaining / entitlement) * 100 : 0;

    // Logic for color: Low balance = Red, Mid = Orange, High = Green
    string barColor = percent < 20 ? "bg-danger" : percent < 50 ? "bg-warning" : "bg-success";
}

<div class="container-fluid py-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">My Leave Dashboard</h2>
            <p class="text-muted mb-0 small">Overview of your leave usage and history.</p>
        </div>
        <a href="/Leave/Leave/Create" class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold">
            <i class="fas fa-plus-circle me-2"></i>Apply for Leave
        </a>
    </div>

    <!-- ANNUAL LEAVE (VACATION) -->
    <div class="card shadow border-0 rounded-4 mb-5 overflow-hidden">
        <div class="card-header bg-white p-4 border-bottom">
            <h5 class="fw-bold text-dark mb-0"><i class="fas fa-umbrella-beach me-2 text-warning"></i>Annual Leave (Vacation)</h5>
        </div>
        <div class="card-body p-4">
            @if (vacation != null)
            {
                <div class="row align-items-center">
                    <!-- Left: Big Number -->
                    <div class="col-md-3 text-center border-end">
                        <h1 class="display-4 fw-bold text-primary mb-0">@remaining</h1>
                        <small class="text-muted fw-bold text-uppercase" style="letter-spacing: 1px;">Days Remaining</small>
                    </div>

                    <!-- Right: Progress Bar -->
                    <div class="col-md-9 ps-md-5">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold text-secondary">
                                <i class="fas fa-chart-pie me-1"></i> Usage Overview
                            </span>
                            <span class="fw-bold text-dark">@used used / @entitlement total</span>
                        </div>

                        <div class="progress rounded-pill bg-light" style="height: 15px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);">
                            <div class="progress-bar @barColor rounded-pill" role="progressbar" style="width: @percent%"></div>
                        </div>

                        <div class="mt-2 text-end">
                            <small class="text-muted fw-bold">@percent.ToString("0")% Available</small>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-0 border-0 d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                    <div>
                        <strong>Not Configured:</strong> Annual leave setup is missing. Please contact HR.
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- POLICY LEAVES -->
    <h5 class="fw-bold text-secondary mb-3 small text-uppercase" style="letter-spacing: 1px;">
        <i class="fas fa-file-contract me-2"></i>Policy Based Leaves
    </h5>

    <div class="row g-3 mb-5">
        @foreach (var item in policyLeaves)
        {
            <div class="col-md-4">
                <!-- Added border-start for a "widget" look -->
                <div class="card shadow-sm border-0 rounded-3 h-100 border-start border-4 border-info">
                    <div class="card-body d-flex align-items-center p-3">
                        <div class="bg-info bg-opacity-10 text-info rounded-circle d-flex justify-content-center align-items-center me-3" style="width: 45px; height: 45px;">
                            <i class="fas fa-info-circle fs-5"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold text-dark mb-0">@item.leave_type</h6>
                            <small class="text-muted" style="font-size: 0.8rem;">HR Controlled / Unlimited</small>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- REQUEST HISTORY -->
    <h5 class="fw-bold text-secondary mb-3 small text-uppercase" style="letter-spacing: 1px;">
        <i class="fas fa-history me-2"></i>Request History
    </h5>

    <div class="card shadow border-0 rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 text-secondary small fw-bold text-uppercase">Leave Type</th>
                        <th class="text-secondary small fw-bold text-uppercase">Reason</th>
                        <th class="text-secondary small fw-bold text-uppercase">Duration</th>
                        <th class="text-secondary small fw-bold text-uppercase text-center">Status</th>
                        <th class="pe-4 text-secondary small fw-bold text-uppercase text-end">Decision Date</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.History.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="far fa-folder-open fa-2x mb-2"></i><br />
                                No leave history found.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var row in Model.History)
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-primary">@row.leave_type</td>
                                <td class="text-muted small">@row.justification</td>
                                <td>
                                    <span class="fw-bold text-dark">@row.duration</span> <span class="text-muted small">days</span>
                                </td>
                                <td class="text-center">
                                    @if (row.status.Contains("Approved"))
                                    {
                                        <span class="badge rounded-pill bg-success bg-opacity-10 text-success border border-success px-3">Approved</span>
                                    }
                                    else if (row.status.Contains("Rejected"))
                                    {
                                        <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger border border-danger px-3">Rejected</span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill bg-warning bg-opacity-10 text-warning border border-warning px-3">Pending</span>
                                    }
                                </td>
                                <td class="pe-4 text-end">
                                    @if (row.approval_timing.HasValue)
                                    {
                                        <span class="fw-bold text-dark">@row.approval_timing.Value.ToString("MMM dd, yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small fst-italic">- Waiting -</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>